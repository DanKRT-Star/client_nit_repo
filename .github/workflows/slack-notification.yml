name: Slack Notifications

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Push Notification
        if: github.event_name == 'push'
        id: push-data
        run: |
          # Escape commit message for JSON
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | jq -Rs . | sed 's/^"//;s/"$//')
          echo "commit_message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "commit_sha_short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Send Push Notification to Slack
        if: github.event_name == 'push'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":rocket: New Commit Pushed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ steps.push-data.outputs.commit_sha_short }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit Message:*\n${{ steps.push-data.outputs.commit_message }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ github.event.head_commit.url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Repository"
                      },
                      "url": "${{ github.event.repository.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Determine PR Action
        if: github.event_name == 'pull_request'
        id: pr-data
        run: |
          # Determine header text based on action
          case "${{ github.event.action }}" in
            opened)
              echo "header_text=:bell: New Pull Request Opened" >> $GITHUB_OUTPUT
              ;;
            reopened)
              echo "header_text=:arrows_counterclockwise: Pull Request Reopened" >> $GITHUB_OUTPUT
              ;;
            synchronize)
              echo "header_text=:repeat: Pull Request Updated" >> $GITHUB_OUTPUT
              ;;
            closed)
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                echo "header_text=:white_check_mark: Pull Request Merged" >> $GITHUB_OUTPUT
              else
                echo "header_text=:x: Pull Request Closed" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "header_text=:memo: Pull Request Event" >> $GITHUB_OUTPUT
              ;;
          esac

          # Escape PR title and body for JSON
          PR_TITLE=$(echo '${{ github.event.pull_request.title }}' | jq -Rs . | sed 's/^"//;s/"$//')
          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT

          PR_BODY='${{ github.event.pull_request.body }}'
          if [ -z "$PR_BODY" ]; then
            PR_BODY="_No description provided_"
          fi
          PR_BODY_ESCAPED=$(echo "$PR_BODY" | jq -Rs . | sed 's/^"//;s/"$//')
          echo "pr_body=${PR_BODY_ESCAPED}" >> $GITHUB_OUTPUT

      - name: Send Pull Request Notification to Slack
        if: github.event_name == 'pull_request'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.pr-data.outputs.header_text }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*PR Number:*\n#${{ github.event.pull_request.number }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branches:*\n`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR Title:*\n${{ steps.pr-data.outputs.pr_title }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Description:*\n${{ steps.pr-data.outputs.pr_body }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": ":heavy_plus_sign: ${{ github.event.pull_request.additions }} additions | :heavy_minus_sign: ${{ github.event.pull_request.deletions }} deletions | :page_facing_up: ${{ github.event.pull_request.changed_files }} files changed"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Pull Request"
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Changes"
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
